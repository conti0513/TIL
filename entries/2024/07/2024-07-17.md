# Today I Learned

## 2024-07-15

### Overview
- tested CI/CD piplines for multiple Python projects using GitHub Actions
- UoPeople ENGL0008 disscussion foram assignment

### CI/CD piplines for multiple Python projects using GitHub Actions
Today, I created and tested CI/CD pipelines for multiple Python projects using GitHub Actions. 
Each project has its own Dockerfile and workflow file, 
enabling automated building and pushing of Docker images to Docker Hub.

### Directory Structure

```plaintext
/workspaces/development_public
├── .github
│   └── workflows
│       ├── docker-publish-project1.yml
│       ├── docker-publish-project2.yml
│       └── ...
├── infra_pjt
│   ├── common
│   │   └── Dockerfile
│   └── python_projects
│       ├── project1
│       │   ├── app.py
│       │   ├── requirements.txt
│       ├── project2
│       │   ├── app.py
│       │   ├── requirements.txt
│       └── ...
└── scripts
    └── create_workflow.sh
```

### Steps

1. **Creating the Workflow Script**:
    - Created a shell script (`create_workflow.sh`) to generate workflow files for normal builds and rollbacks.
    - Each project has its own Dockerfile and corresponding workflow file.

2. **Sample Shell Script to Generate Workflow**:
    ```sh
    #!/bin/bash

    echo "Starting to create a workflow..."

    # Interactive user input
    read -p "Enter workflow type (normal/rollback): " workflow_type
    read -p "Enter project name (e.g., project1): " project_name

    # Current directory
    current_dir=$(pwd)

    # Path to the YAML file
    yaml_file="$current_dir/../../.github/workflows/docker-publish-${project_name}.yml"

    # Generate YAML content
    if [ "$workflow_type" == "normal" ]; then
        cat <<EOL > $yaml_file
    name: Build and Push Docker Image

    on:
      push:
        branches:
          - main

    jobs:
      build-and-push-python:
        runs-on: ubuntu-latest

        steps:
          - name: Checkout repository
            uses: actions/checkout@v2

          - name: Set up Docker Buildx
            uses: docker/setup-buildx-action@v1

          - name: Login to Docker Hub
            uses: docker/login-action@v1
            with:
              username: \${{ secrets.DOCKER_USERNAME }}
              password: \${{ secrets.DOCKER_PASSWORD }}

          - name: Build and push
            uses: docker/build-push-action@v2
            with:
              context: ./infra_pjt/python_projects/${project_name}
              file: ./infra_pjt/common/Dockerfile
              push: true
              platforms: linux/amd64,linux/arm64
              tags: butainco/${project_name}:latest

    EOL
    elif [ "$workflow_type" == "rollback" ]; then
        cat <<EOL > $yaml_file
    name: Rollback Docker Image

    on:
      workflow_dispatch:

    jobs:
      rollback-python:
        runs-on: ubuntu-latest

        steps:
          - name: Checkout repository
            uses: actions/checkout@v2

          - name: Set up Docker Buildx
            uses: docker/setup-buildx-action@v1

          - name: Login to Docker Hub
            uses: docker/login-action@v1
            with:
              username: \${{ secrets.DOCKER_USERNAME }}
              password: \${{ secrets.DOCKER_PASSWORD }}

          - name: Rollback
            run: |
              docker pull butainco/${project_name}:previous
              docker tag butainco/${project_name}:previous butainco/${project_name}:latest
              docker push butainco/${project_name}:latest

    EOL
    else
        echo "Invalid workflow type: $workflow_type"
        exit 1
    fi

    echo "Workflow file created successfully: $yaml_file"
    ```

3. **Generating the Workflow File**:
    - Run the shell script and follow the prompts to create the workflow file for each project.

### Results

- Successfully created shell scripts to automate the generation of CI/CD workflow files.
- Verified the functionality of the generated workflow files using GitHub Actions.

---

here are the absolute paths for each component:

### YAML Files
/workspaces/development_public/.github/workflows/docker-publish-project1.yml
/workspaces/development_public/.github/workflows/docker-publish-project2.yml

### Create Workflow Script
  `/workspaces/development_public/infra_pjt/scripts/create_workflow.sh`

### Each Python Project
/workspaces/development_public/infra_pjt/python_projects/project1/app.py
/workspaces/development_public/infra_pjt/python_projects/project1/requirements.txt

### Common Dockerfile
/workspaces/development_public/infra_pjt/common/Dockerfile